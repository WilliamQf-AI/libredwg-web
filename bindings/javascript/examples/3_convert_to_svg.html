<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convert Dwg to SVG</title>
</head>
<body>
    <h1>Convert DWG/DXF to SVG</h1>
    <p>Notes: support arc, circle, ellipse, insert, line, mtext, polyline, ray, text, and xline only.</p>
    <input type="file" id="fileInput" accept=".dwg,.dxf" />
    <button id="download-svg-btn" disabled>Download SVG</button>
    <br><br>
    <div id="svg-container"></div>
    <script type="module" src="dist/libredwg-web.js" defer></script>
    <script type="module" >
      import { Dwg_File_Type, LibreDwg } from './dist/libredwg-web.js'

      // load libredwg webassembly module
      const libredwg = await LibreDwg.create()

      document.getElementById('download-svg-btn').addEventListener('click', () => {
        const svg = document.querySelector('#svg-container svg');
        if (!svg) {
          alert('No SVG to download!')
          return
        }

        const serializer = new XMLSerializer()
        const svgContent = serializer.serializeToString(svg)
        const blob = new Blob([svgContent], { type: 'image/svg+xml' })
        const url = URL.createObjectURL(blob)

        const a = document.createElement('a')
        a.href = url
        a.download = 'drawing.svg'
        document.body.appendChild(a)
        a.click()
        document.body.removeChild(a)
        URL.revokeObjectURL(url)
      })
    
      // handle file input change event
      const fileInput = document.getElementById('fileInput')
      fileInput.addEventListener('change', function(event) {
        const file = event.target.files[0]
        if (file) {
          // create a FileReader to read the file
          const reader = new FileReader()

          // define the callback function for when the file is read
          reader.onload = function(e) {
            const fileContent = e.target.result
            console.log('Selected file:', file.name, 'size:', file.size)
            // preview first bytes as string (if text) and hex
            try {
              const view = new Uint8Array(fileContent.slice(0, 128))
              const asText = new TextDecoder().decode(view)
              console.log('File preview (text):', asText.slice(0, 200))
              console.log('File preview (hex):', Array.from(view.slice(0, 32)).map(b => b.toString(16).padStart(2,'0')).join(' '))
            } catch (err) {
              console.warn('Could not preview file bytes', err)
            }
            try {
              // detect file type by extension (fallback to DWG)
              const name = file.name || ''
              const lower = name.toLowerCase()
              const fileType = lower.endsWith('.dxf') ? Dwg_File_Type.DXF : Dwg_File_Type.DWG

              // call and log raw result/pointer
              let dwg = libredwg.dwg_read_data(fileContent, fileType)
              console.log('dwg read result:', dwg)
              // If DXF was provided, write it out as a DWG and re-read
              // as DWG to normalize parsing (some DXF variants populate
              // different internal structures).
              if (fileType === Dwg_File_Type.DXF) {
                try {
                  const tmpName = 'tmp_from_dxf.dwg'
                  const writeErr = libredwg.dwg_write_file(tmpName, dwg)
                  console.log('dwg_write_file result:', writeErr)
                  // some embind wrappers may return an object { error: n }
                  let writeErrCode = 0
                  if (typeof writeErr === 'object' && writeErr !== null) {
                    writeErrCode = writeErr.error ?? writeErr.code ?? 1
                  } else {
                    writeErrCode = Number(writeErr)
                  }
                  if (writeErrCode === 0) {
                    try {
                      // read back the binary and parse as DWG
                      const bin = libredwg.wasmInstance.FS.readFile(tmpName)
                      try {
                        // Log written DWG header for debugging
                        const head = bin.slice(0, 128)
                        const headText = Array.from(head).map(b => (b >= 32 && b < 127) ? String.fromCharCode(b) : '.').join('')
                        console.log('Written DWG bin size:', bin.length)
                        console.log('Written DWG header (text):', headText)
                        console.log('Written DWG header (hex):', Array.from(head.slice(0,32)).map(b=>b.toString(16).padStart(2,'0')).join(' '))
                      } catch(e) {
                        console.warn('Could not inspect written DWG binary', e)
                      }
                      // free previous dwg and re-parse as DWG
                      libredwg.dwg_free(dwg)
                      dwg = libredwg.dwg_read_data(bin.buffer, Dwg_File_Type.DWG)
                      console.log('re-read dwg pointer:', dwg)
                      // cleanup tmp file
                      try { libredwg.wasmInstance.FS.unlink(tmpName) } catch(e) {}
                    } catch (err) {
                      console.warn('Failed to read back DWG fallback', err)
                    }
                  } else {
                    console.warn('Could not write DWG fallback, proceeding with original parse')
                  }
                } catch (err) {
                  console.warn('DXF->DWG conversion failed', err)
                }
              }
              try {
                const numObjects = libredwg.dwg_get_num_objects(dwg)
                const numClasses = libredwg.dwg_get_num_classes(dwg)
                console.log('dwg num_objects:', numObjects, 'num_classes:', numClasses)
              } catch (err) {
                console.warn('Could not query dwg internals', err)
              }

              // use convertEx to get conversion statistics for diagnostics
              const { database: db, stats } = libredwg.convertEx(dwg)
              console.log('convertEx stats:', stats)

                try {
                  console.log('db tables BLOCK_RECORD count:', db.tables.BLOCK_RECORD.entries.length)
                  console.log('block record names sample:', db.tables.BLOCK_RECORD.entries.slice(0,5).map(b=>b.name))
                    console.log('db.entities length:', db.entities.length)
                    // Detailed per-block diagnostics to help trace empty model-space
                    db.tables.BLOCK_RECORD.entries.forEach((btr, idx) => {
                      try {
                        const ents = Array.isArray(btr.entities) ? btr.entities.length : (btr.entities ? Object.keys(btr.entities).length : 0)
                        console.log(`BTR[${idx}] name=${btr.name} num_owned=${btr.num_owned || 'unknown'} entities.length=${ents}`)
                        if (ents > 0) {
                          console.log(`BTR[${idx}] sample entity:`, btr.entities[0])
                        }
                      } catch (err) {
                        console.warn('Could not inspect block record', idx, err)
                      }
                    })
                } catch (err) {
                  console.warn('Could not inspect db structure', err)
                }

              // if database seems empty, bail out early with info
              if (!db || (Array.isArray(db.objects) && db.objects.length === 0)) {
                console.warn('Converted database appears empty â€” no objects to render')
                document.getElementById('download-svg-btn').disabled = true
                libredwg.dwg_free(dwg)
                return
              }

              const svgString = libredwg.dwg_to_svg(db)

              const parser = new DOMParser()
              const doc = parser.parseFromString(svgString, 'image/svg+xml')
              const svg = doc.documentElement
              const svgContainer = document.getElementById('svg-container')
              svgContainer.innerHTML = ''
              svgContainer.appendChild(svg)

              libredwg.dwg_free(dwg)
              document.getElementById('download-svg-btn').disabled = false
            } catch (error) {
              document.getElementById('download-svg-btn').disabled = true
              console.error('Failed to process dwg file: ', error)
            }
          }

          // read the file
          reader.readAsArrayBuffer(file)
        } else {
          document.getElementById('download-svg-btn').disabled = true
          console.log('No file selected')
        }
      })
    </script>
</body>
</html>